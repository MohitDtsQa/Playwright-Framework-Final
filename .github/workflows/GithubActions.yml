name: Playwright With Github Actions

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # 4Ô∏è‚É£ Install Playwright browsers
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

      - name: Verify Playwright browser cache path
        if: always()
        run: |
          echo "PLAYWRIGHT_BROWSERS_PATH=$PLAYWRIGHT_BROWSERS_PATH"
          ls -la "$PLAYWRIGHT_BROWSERS_PATH" || true

      # 5Ô∏è‚É£ Install Allure CLI
      - name: Install Allure CLI
        run: npm install -D allure-commandline

      # 6Ô∏è‚É£ Run Playwright tests
      - name: Run Playwright tests
        run: xvfb-run -a npx playwright test
        continue-on-error: true

      # 7Ô∏è‚É£ Generate Allure HTML report
      - name: Generate Allure report
        if: always()
        run: npx allure-commandline generate results_reports/allure-results --clean -o results_reports/allure-report

      # 8Ô∏è‚É£ Upload Playwright test-results artifacts
      - name: Upload Playwright test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: results_reports/test-results/
          retention-days: 30

      # 8Ô∏è‚É£b Upload custom artifacts (screenshots/videos)
      - name: Upload custom artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: custom-artifacts
          path: artifacts/
          retention-days: 30

      # 9Ô∏è‚É£ Upload Playwright HTML report
      - name: Upload Playwright report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: results_reports/playwright-report/
          retention-days: 30

      # üîü Upload Allure report
      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: results_reports/allure-report/
          retention-days: 30

      # 1Ô∏è‚É£1Ô∏è‚É£ Prepare GitHub Pages content (Reports + Artifacts)
      - name: Prepare Pages content
        if: always()
        run: |
          mkdir -p pages/playwright
          mkdir -p pages/allure
          mkdir -p pages/artifacts

          # Copy reports
          cp -r results_reports/playwright-report/* pages/playwright/
          cp -r results_reports/allure-report/* pages/allure/

          # Copy artifacts from root/artifacts/ directory
          if [ -d "artifacts" ]; then
            cp -r artifacts/* pages/artifacts/
          fi

          # Copy test-results if exists
          if [ -d "results_reports/test-results" ]; then
            cp -r results_reports/test-results/* pages/artifacts/
          fi

          # Copy HTML templates and scripts from .github/workflows/html-templates
          cp .github/workflows/html-templates/artifacts-index.html pages/artifacts/index.html
          cp .github/workflows/html-templates/generate-artifacts-list.sh pages/artifacts/generate-list.sh
          cp .github/workflows/html-templates/landing-page.html pages/index.html

          # Generate artifacts list JSON
          chmod +x pages/artifacts/generate-list.sh
          cd pages/artifacts && ./generate-list.sh > artifacts-list.json && cd ../..

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Pages artifact (ONLY ONCE)
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

      # 1Ô∏è‚É£3Ô∏è‚É£ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4
